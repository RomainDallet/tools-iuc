<tool id="last_db" name="LASTdb" version="@LAST_CONDA_VERSION@+galaxy0" python_template_version="3.5">

    <description>prepares sequences for subsequent comparison and alignment using lastal.</description>

    <macros>
        <import>macros_last.xml</import>
    </macros>

    <requirements>
        <requirement type="package" version="@LAST_CONDA_VERSION@">last</requirement>
    </requirements>

    <command detect_errors="exit_code"><![CDATA[
        #import shutil

        lastdb
        -Q $lastdb.input_format
        $lastdb.sequences_type.protein
        -a $lastdb.sequences_type.symbols
        -R $lastdb.repeats.uppercase$lastdb.repeats.simple_repeat
        $lastdb.repeats.sm_lower
        -S $lastdb.lastdb_advanced.strand
        -u $lastdb.lastdb_advanced.seeds.seeding_scheme
        -w $lastdb.lastdb_advanced.seeds.step
        -W $lastdb.lastdb_advanced.seeds.size
        -m $lastdb.lastdb_advanced.seeds.pattern
        -i $lastdb.lastdb_advanced.matches
        -C $lastdb.lastdb_advanced.child_table
        ref_genome
        '$ref_fasta'

        &

        #if not os.path.exists("$outfile.files_path" + "/lastdb_files"):
            '${os.makedirs("$outfile.files_path" + "/lastdb_files")}'
        #end if

        #if os.path.exists("$outfile.files_path" + "/lastdb_files"):
            #for file in '${os.listdir($outfile.files_path)}':
                #if file.startswith("ref_genome"):
                    '${shutil.copy2(file, $outfile.files_path + "/lastdb_files")}'
                #end if
            #end for
        #end if

        '${$outfile.files_path + "/lastdb_files"}' > '$outfile'

    ]]></command>
    <!--
        '${$outfile.files_path + "/lastdb_files"}' > '$outfile'
        '${os.path.join($outfile.files_path, "ref_genome")}'
        '${os.listdir($outfile.files_path + "/lastdb_files")}' > '$outfile'        
        > '$outfile'

        lastdb        
        -s \$GALAXY_MEMORY_MB
        -P \${GALAXY_SLOTS:-1}
    -->
    <inputs>
        <param name="ref_fasta" type="data" format="fasta" label="Reference sequence fasta file" />
        <section name="lastdb" title="Lastdb arguments" expanded="true">
            <param name="input_format" argument="-Q" type="select" multiple="false" label="Input format">
                <option value="0" selected="true">fasta or fastq-ignore</option>
                <option value="1">fastq-sanger</option>
                <option value="2">fastq-solexa</option>
                <option value="3">fastq-illumina</option>
            </param>

            <conditional name="sequences_type">
                <param name="protein" type="select" multiple="false" label="The sequences are :">
                    <option value="" selected="true">DNA</option>
                    <option value="-p">Proteins (-p)</option>
                </param>
                <when value="">
                    <param name="symbols" argument="-a" type="text" value="ACGT" label="User-defined alphabet."/>
                </when>
                <when value="-p">
                    <param name="symbols" argument="-a" type="text" value="ACDEFGHIKLMNPQRSTVWY" label="User-defined alphabet."/>
                </when>
            </conditional>

            <section name="repeats" title="Specify lowercase-marking of repeats. (-R)" expanded="false">
                <param name="uppercase" type="select" multiple="false" label="Convert the input sequences to uppercase while reading them.">
                    <option value="0">Convert the input sequences to uppercase while reading them. (0)</option>
                    <option value="1" selected="true">Keep any lowercase in the input sequences. (1)</option>
                </param>
                <param name="simple_repeat" type="select" multiple="false" label="Check for simple repeats.">
                    <option value="0" selected="true">Do not check for simple repeats.(0)</option>
                    <option value="1">Convert simple repeats to lowercase.(1)</option>
                    <option value="2">Convert simple DNA repeats to lowercase.(2)</option>
                </param>
                <param name="sm_lower" argument="-c" type="boolean" truevalue="-c" falsevalue="" checked="true" label="Soft-mask lowercase letters." help="This means that, when we compare these sequences to some other sequences using lastal, lowercase letters will be excluded from initial matches. This will apply to lowercase letters in both sets of sequences."/>
            </section>

            <section name="lastdb_advanced" title="Advanced options" expanded="false">
                <param name="strand" argument="-S" type="select" multiple="false" label="Strand">
                    <option value="0">Reverse</option>
                    <option value="1" selected="true">Forward</option>
                    <option value="2">Both</option>
                </param>

                <conditional name="seeds">
                    <param name="seeding_scheme" argument="-u" type="select" multiple="false" label="Specify a seeding scheme.">
                        <option value="BISF">BISF</option>
                        <option value="BISR">BISR</option>
                        <option value="MAM4">MAM4</option>
                        <option value="MAM8">MAM8</option>
                        <option value="MURPHY10">MURPHY10</option>
                        <option value="NEAR">NEAR</option>
                        <option value="YASS" selected="true">YASS</option>
                        <!-- Add filename option -->
                    </param>
                    <when value="BISF">
                        <expand macro="step_macro" step="2"/>
                    </when>
                    <when value="BISR">
                        <expand macro="step_macro" step="2"/>
                    </when>
                    <when value="MAM4">
                        <expand macro="step_macro" step="1"/>
                    </when>
                    <when value="MAM8">
                        <expand macro="step_macro" step="1"/>
                    </when>
                    <when value="MURPHY10">
                        <expand macro="step_macro" step="1"/>
                    </when>
                    <when value="NEAR">
                        <expand macro="step_macro" step="1"/>
                        <!-- It sets this lastal default: -r6 -q18 -a21 -b9 -->
                    </when>
                    <when value="YASS">
                        <expand macro="step_macro" step="1"/>
                    </when>
                </conditional>

                <!-- lastal m > i -->
                <param name="matches" argument="-i" type="integer" value="0" label="Minimum limit on initial matches per query position"/>

                <param name="child_table" argument="-C" type="select" multiple="false" label="Child table type">
                    <option value="0" selected="true">None</option>
                    <option value="1">Byte-size</option>
                    <option value="2">Short-syze</option>
                    <option value="3">Full</option>
                </param>
                <!--
                <param name="count" argument="-x" type="boolean" truevalue="-x" falsevalue="" checked="true" label="Just count sequences and letters."/>                    
                <param name="bucket_depth" type="" label="Bucket depth (-b)"/>
                -->
            </section>
        </section>
    </inputs>

    <outputs>
        <!--<data name="outfile" format="data" label="LAST database from ${on_string}"/>-->
        <collection name="outfile" type="list" label="LAST database files">
            <discover_datasets pattern="ref_genome.*" directory="lastdb_files"/>
        </collection>
    </outputs>

    <tests>
        <test>
            <param name="sm_lower" value="true" />
            <param name="uppercase" value="0" />
            <param name="simple_repeat" value="1" />
            <param name="ref_fasta" value="humanMito.fa" />
            <output name="outfile" file="humanMito-fuguMito.maf" />
        </test>
    </tests>

    <help><![CDATA[
        LAST finds similar regions between sequences.

        The main technical innovation is that LAST finds initial matches based on their multiplicity, instead of using a fixed length (e.g. BLAST uses 11-mers). To find these variable-length matches, it uses a suffix array (inspired by Vmatch). To achieve high sensitivity, it uses a spaced suffix array (or subset suffix array), analogous to spaced seeds (or subset seeds).

        LAST can:
            - Handle big sequence data, e.g:
                - Compare two vertebrate genomes.
                - Align billions of DNA reads to a genome.
            - Indicate the reliability of each aligned column.
            - Use sequence quality data properly.
            - Compare DNA to proteins, with frameshifts.
            - Compare PSSMs to sequences.
            - Calculate the likelihood of chance similarities between random sequences.
            - Do split and spliced alignment.
            - Train alignment parameters for unusual kinds of sequence (e.g. nanopore).

    ]]></help>
    <citations></citations>
</tool>
