<tool id="last_train" name="LAST-train" version="@LAST_CONDA_VERSION@+galaxy0" python_template_version="3.5">

    <description>finds the rates (probabilities) of insertion, deletion, and substitutions between two sets of sequences.</description>

    <macros>
        <import>macros_last.xml</import>
    </macros>

    <requirements>
        <requirement type="package" version="@LAST_CONDA_VERSION@">last</requirement>
    </requirements>

    <command detect_errors="exit_code"><![CDATA[

        cp -R '$lastdb_genome.extra_files_path/.' . &&

        last-train

        -Q $init_options.input_format

        -r $init_options.match_score
        -q $init_options.mismatch_cost

        -a $init_options.cost_opt.gap_existence_cost
        -b $init_options.cost_opt.gap_extension_cost
        -A $init_options.cost_opt.insertion_existence_cost
        -B $init_options.cost_opt.insertion_extension_cost

        -D $last_train_opt.align_opt.query_letters
        -E $last_train_opt.align_opt.max_exp_align
        -s $last_train_opt.align_opt.strand
        -S $last_train_opt.align_opt.score_matrix_strand
        -T $last_train_opt.align_opt.type_align
        -m $last_train_opt.align_opt.max_init_matches
        -k $last_train_opt.align_opt.init_matches
        -X $last_train_opt.align_opt.match_mismatch

        -P \${GALAXY_SLOTS:-1}

        'ref_db'

        '$query_fasta'

        >'$outfile'

    ]]></command>
    <!--
        last-train
        -C
        -p $score_matrix

    -->
    <inputs>
        <param name="lastdb_genome" type="data" label="Reference LASTdb data file" />
        <param name="query_fasta" type="data" format="fasta" label="Queries input files" />
	<!--
        <param name="score_matrix" argument="-p" type="select" multiple="false" label="Match/mismatch score matrix.">
            <option value="AT77">AT77</option>
            <option value="ATMAP">ATMAP</option>
            <option value="BISF">BISF</option>
            <option value="BISR">BISR</option>
            <option value="BL62">BLOSUM62</option>
            <option value="BL80" selected="true">BLOSUM80</option>
            <option value="HOXD70">HOXD70</option>
            <option value="MIQS">MIQS</option>
            <option value="PAM10">PAM10</option>
            <option value="PAM30">PAM30</option>                    
            <option value="scoreFile">Other score matrix</option>
        </param>
	-->
        <conditional name="init_options">            
            <param name="input_format" argument="-Q" type="select" multiple="false" label="Input format">
                <option value="0" selected="true">Fasta or fastq-ignore</option>
                <option value="1">Fastq-sanger</option>
            </param>
            <when value="0">
                <param name="match_score" argument="-r" type="integer" value="5" label="Match score"/>
                <param name="mismatch_cost" argument="-q" type="integer" value="5" label="Mismatch cost"/>
                <expand macro="cost_macro" a="15" b="3"/>
            </when>
            <when value="1">
                <param name="match_score" argument="-r" type="integer" value="6" label="Match score"/>
                <param name="mismatch_cost" argument="-q" type="integer" value="18" label="Mismatch cost"/>
                <expand macro="cost_macro" a="21" b="9"/>
            </when>
        </conditional>

        <section name="last_train_opt" title="Last-train options" expanded="false">
            <section name="training_opt" title="Training options" expanded="true">
                <param name="revsym" argument="--revsym" type="boolean" truevalue="--revsym" falsevalue="" checked="false"/>
            </section>

            <section name="align_opt" title="Alignment options" expanded="true">
                <param name="query_letters" argument="-D" type="integer" value="1000000" label="Query letters per random alignment"/>
                <param name="max_exp_align" argument="-E" type="integer" value="10" label="Maximum expected alignments per square giga"/>
                <param name="strand" argument="-s" type="select" multiple="false" label="Query strand to use">
                    <option value="0">Reverse</option>
                    <option value="1" selected="true">Forward</option>
                    <option value="2">Both</option>
                </param>
                <param name="score_matrix_strand" argument="-S" type="select" multiple="false" label="Score matrix applies to forward strand of:">
                    <option value="0">Reference</option>
                    <option value="1" selected="true">Query</option>
                </param>                
                <!--<param name="gapless_align" argument="-C" type="integer" value="" label="Omit gapless alignments in COUNT others with > score-per-length"/>-->
                <param name="type_align" argument="-T" type="select" multiple="false" label="Type of alignment:">
                    <option value="0" selected="true">Local</option>
                    <option value="1">Overlap</option>
                </param>
                <param name="max_init_matches" argument="-m" type="integer" value="10" label="Maximum initial matches per query position"/>
                <param name="init_matches" argument="-k" type="integer" value="1" label="Use initial matches starting at every STEP-th position in each query"/>
                <param name="match_mismatch" argument="-X" type="select" multiple="false" label="N/X is ambiguous in:">
                    <option value="0" selected="true">Neither sequence</option>
                    <option value="1">Reference</option>
                    <option value="2">Query</option>
                    <option value="3">Both</option>
                </param>
            </section>
        </section>
    </inputs>

    <outputs>
        <data name="outfile" format="txt" label="LAST train from ${on_string}" />
    </outputs>

    <tests>
        <test>
            <param name="lastdb_genome" value="ref_db.txt">
                <extra_files type="file" value="ref_db.bck" name="ref_db.bck"/>
                <extra_files type="file" value="ref_db.des" name="ref_db.des"/>
                <extra_files type="file" value="ref_db.prj" name="ref_db.prj"/>
                <extra_files type="file" value="ref_db.sds" name="ref_db.sds"/>
                <extra_files type="file" value="ref_db.ssp" name="ref_db.ssp"/>
                <extra_files type="file" value="ref_db.suf" name="ref_db.suf"/>
                <extra_files type="file" value="ref_db.tis" name="ref_db.tis"/>
            </param>
            <param name="query_fasta" value="fuguMito.fa"/>
            <output name="outfile" file="last_train.txt" ftype="txt"/>
        </test>
    </tests>

    <help>@LAST_HELP@</help>
    <citations><expand macro="citations"/></citations>
</tool>
